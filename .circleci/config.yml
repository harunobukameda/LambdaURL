version: 2.1

orbs:
  aws-cli: circleci/aws-cli@4.0.0

jobs:
  deploy-lambda:
    executor:
      name: aws-cli/default
    steps:
      - checkout

      # Node.js 環境構築（OrbのexecutorではNodeがないため手動でセットアップ）
      - run:
          name: "Install Node.js and npm packages"
          command: |
            curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
            apt-get install -y nodejs
            npm install

      # Lint & Test
      - run:
          name: "Run linting and tests"
          command: |
            npm run lint || echo "Linting issues found, but continuing deployment"
            npm test

      # AWS CLIのセットアップ（orbで済む）
      - aws-cli/setup:
          aws-access-key-id: AWS_ACCESS_KEY_ID
          aws-secret-access-key: AWS_SECRET_ACCESS_KEY
          aws-region: ap-northeast-1

      # デプロイ用パッケージ作成
      - run:
          name: "Create deployment package"
          command: |
            mkdir -p deploy
            cp index.mjs deploy/
            cd deploy
            zip -r lambda_function.zip .

      # Lambda関数の作成 or 更新
      - run:
          name: "Deploy Lambda function with URL"
          command: |
            echo "Deploying Lambda function..."

            aws lambda create-function \
              --region ap-northeast-1 \
              --function-name LambdaURL \
              --runtime nodejs18.x \
              --handler index.handler \
              --zip-file fileb://deploy/lambda_function.zip \
              --role $AWS_LAMBDA_ROLE_ARN || {
                echo "Function may already exist, attempting to update..."
                aws lambda update-function-code \
                  --region ap-northeast-1 \
                  --function-name LambdaURL \
                  --zip-file fileb://deploy/lambda_function.zip
              }

            echo "Creating function URL config..."
            aws lambda create-function-url-config \
              --region ap-northeast-1 \
              --function-name LambdaURL \
              --auth-type NONE || true

            echo "Retrieving Lambda URL..."
            aws lambda get-function-url-config \
              --region ap-northeast-1 \
              --function-name LambdaURL || echo "Could not retrieve function URL."

workflows:
  deploy-lambda-workflow:
    jobs:
      - deploy-lambda:
          context:
            - aws-credentials
          filters:
            branches:
              only: main
